<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Graffiti</title>
<link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
<div id="app">
  <div id="feed"></div>

  <!-- Tambahkan di dalam <body>, setelah #app -->
<button id="floatingBtn">ğŸ’¬</button>

  <div id="inputArea">
    <!-- thumbnail -->
    <div id="thumbnailContainer"></div>

    <textarea id="input1" placeholder="Bombing.."></textarea>
    <input type="file" id="uploadImg" accept="image/*" multiple style="display:none;">
    
    <!-- Canvas -->
    <div id="canvasWrapper">
      <canvas id="drawCanvas" width="500" height="300"></canvas>
      <div id="tools">
        <button id="colorPreview" class="colorPreview"></button>
        <input type="color" id="brushColor" value="#000000" style="display:none;">

        <!-- Brush size picker -->
        <div id="sizeWrapper">
          <div id="sizeBtn"></div>
          <div id="sizeTooltip"></div>
        </div>

        <button onclick="clearCanvas()">ğŸ§¹ Clear</button>
      </div>
    </div>

    <input type="text" id="input2" placeholder="Tag" required>

    <!-- tombol -->
    <button onclick="post()">Post</button>
    <button id="drawBtn" onclick="toggleDrawing()">âœï¸ Draw</button>
    <button onclick="document.getElementById('uploadImg').click()">ğŸ–¼ï¸ Upload</button>
  </div>
</div>

<script>
const feed = document.getElementById("feed");
const input1 = document.getElementById("input1");
const input2 = document.getElementById("input2");
const uploadImg = document.getElementById("uploadImg");
const thumbnailContainer = document.getElementById("thumbnailContainer");

const canvasWrapper = document.getElementById("canvasWrapper");
const canvas = document.getElementById("drawCanvas");
const ctx = canvas.getContext("2d");
const drawBtn = document.getElementById("drawBtn");
const brushColor = document.getElementById("brushColor");
const colorPreview = document.getElementById("colorPreview");

const sizeWrapper = document.getElementById("sizeWrapper");
const sizeBtn = document.getElementById("sizeBtn");
const sizeTooltip = document.getElementById("sizeTooltip");

let drawing = false;
let useDrawing = false;
let lastX = 0, lastY = 0;
let currentColor = brushColor.value;
let brushSize = 2;
let uploadedImages = [];

// sync awal
colorPreview.style.background = currentColor;
colorPreview.addEventListener("click", () => brushColor.click());
brushColor.addEventListener("input", () => {
  currentColor = brushColor.value;
  colorPreview.style.background = currentColor;
  updateCursor();
});

// Mobile detection
function isMobile() {
  return /Mobi|Android/i.test(navigator.userAgent);
}

const inputArea = document.getElementById("inputArea");
const floatingBtn = document.getElementById("floatingBtn");

if (isMobile()) {
  // hide inputArea secara default
  inputArea.style.display = "none";
  // tampilkan floating button
  floatingBtn.style.display = "block";

  floatingBtn.addEventListener("click", () => {
    if (inputArea.style.display === "none") {
      inputArea.style.display = "block";
      floatingBtn.textContent = "âŒ"; // tombol close
    } else {
      inputArea.style.display = "none";
      floatingBtn.textContent = "ğŸ’¬"; // tombol chat
    }
  });
}


// brush size dynamic 1-20
sizeTooltip.innerHTML = "";
for (let i = 1; i <= 20; i++) {
  const opt = document.createElement("div");
  opt.className = "sizeOption";
  opt.dataset.size = i;
  const px = i + 8;
  opt.style.width = px + "px";
  opt.style.height = px + "px";
  sizeTooltip.appendChild(opt);
}
const sizeOptionsNew = sizeTooltip.querySelectorAll(".sizeOption");

// default brush
brushSize = 2;
updateSizeBtn(brushSize);
sizeOptionsNew[brushSize - 1].classList.add("active");

// size button & tooltip
sizeBtn.addEventListener("click", e => {
  e.stopPropagation();
  sizeTooltip.style.display = (sizeTooltip.style.display === "flex") ? "none" : "flex";
});

sizeOptionsNew.forEach(opt => {
  opt.addEventListener("click", () => {
    sizeOptionsNew.forEach(o => o.classList.remove("active"));
    opt.classList.add("active");
    brushSize = parseInt(opt.dataset.size);
    updateSizeBtn(brushSize);
    updateCursor();
    sizeTooltip.style.display = "none";
  });
});

document.addEventListener("click", (e) => {
  if (!sizeWrapper.contains(e.target)) sizeTooltip.style.display = "none";
});

function updateSizeBtn(size) {
  sizeBtn.innerHTML = "";
  const circle = document.createElement("div");
  circle.style.width = size + "px";
  circle.style.height = size + "px";
  circle.style.borderRadius = "50%";
  circle.style.background = "#fff";
  sizeBtn.appendChild(circle);
}

// toggle drawing
function toggleDrawing() {
  useDrawing = !useDrawing;
  if (useDrawing) {
    input1.style.display = "none";
    thumbnailContainer.style.display = "none";
    canvasWrapper.style.display = "flex";
    drawBtn.textContent = "âŒ Close";
  } else {
    input1.style.display = "block";
    thumbnailContainer.style.display = "flex";
    canvasWrapper.style.display = "none";
    drawBtn.textContent = "âœï¸ Draw";
  }
}

// pastikan di CSS canvas
canvas.style.touchAction = "none"; // penting agar scroll tidak terjadi saat touch

// canvas drawing
function getCanvasCoords(clientX, clientY) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}

canvas.addEventListener("pointerdown", e => {
  e.preventDefault(); // cegah scroll/zoom
  const pos = getCanvasCoords(e.clientX, e.clientY);
  drawing = true;
  lastX = pos.x;
  lastY = pos.y;
});

canvas.addEventListener("pointermove", e => {
  if (!drawing) return;
  e.preventDefault(); // cegah scroll/zoom
  const pos = getCanvasCoords(e.clientX, e.clientY);

  ctx.strokeStyle = currentColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = "round";

  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();

  lastX = pos.x;
  lastY = pos.y;
});

canvas.addEventListener("pointerup", () => drawing = false);
canvas.addEventListener("pointerleave", () => drawing = false);
canvas.addEventListener("pointercancel", () => drawing = false);

// clear canvas
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// cursor brush
function updateCursor() {
  const cursorCanvas = document.createElement("canvas");
  const size = brushSize * 2;
  cursorCanvas.width = size;
  cursorCanvas.height = size;
  const cursorCtx = cursorCanvas.getContext("2d");
  cursorCtx.fillStyle = currentColor;
  cursorCtx.beginPath();
  cursorCtx.arc(size / 2, size / 2, brushSize / 2, 0, Math.PI*2);
  cursorCtx.fill();

  const dataURL = cursorCanvas.toDataURL();
  canvas.style.cursor = `url(${dataURL}) ${brushSize} ${brushSize}, crosshair`;
}

// panggil awal
updateCursor();


// upload multi image
uploadImg.addEventListener("change", e => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      uploadedImages.push(ev.target.result);
      renderThumbnails();
    };
    reader.readAsDataURL(file);
  });
  uploadImg.value = "";
});

// render thumbnails
function renderThumbnails() {
  thumbnailContainer.innerHTML = "";
  uploadedImages.forEach((src, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "thumbWrapper";

    const img = document.createElement("img");
    img.src = src;

    const btn = document.createElement("button");
    btn.className = "removeThumb";
    btn.textContent = "x";
    btn.onclick = () => {
      uploadedImages.splice(index, 1);
      renderThumbnails();
    };

    wrapper.appendChild(img);
    wrapper.appendChild(btn);
    thumbnailContainer.appendChild(wrapper);
  });
}



// post
function post() {
  let val1 = input1.value.trim();
  const val2 = input2.value.trim();
  let imgData = null;
  if (useDrawing) imgData = canvas.toDataURL("image/png");

  if (val1 || val2 || imgData || uploadedImages.length > 0) {
    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if (uploadedImages.length > 0) {
      uploadedImages.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.style.maxWidth = "100%";
        img.style.borderRadius = "8px";
        img.style.marginBottom = "6px";
        bubble.appendChild(img);
      });
      uploadedImages = [];
      renderThumbnails();
    }

    if (imgData) {
      const img = document.createElement("img");
      img.src = imgData;
      img.style.maxWidth = "100%";
      img.style.borderRadius = "8px";
      img.style.marginBottom = "6px";
      img.style.background = "#fff"; // background sesuai kanvas
      img.style.padding = "4px";     // padding agar ada jarak dari tepi
      img.style.display = "block";
      bubble.appendChild(img);
      clearCanvas();
    }

    if (val1) {
      const out1 = document.createElement("div");
      out1.className = "output1";
      out1.textContent = val1;
      bubble.appendChild(out1);
    }

    if (val2) {
      const out2 = document.createElement("div");
      out2.className = "output2";
      out2.textContent = "~ " + val2;
      bubble.appendChild(out2);
    }

    feed.appendChild(bubble);
    feed.scrollTop = feed.scrollHeight;
    input1.value = "";
    input2.value = "";
    input1.focus();  // kursor tetap di input1
    input1.style.display = "block";
    thumbnailContainer.style.display = "flex";
    canvasWrapper.style.display = "none";
    useDrawing = false;
    drawBtn.textContent = "âœï¸ Draw";
  }
}

</script>
</body>
</html>
